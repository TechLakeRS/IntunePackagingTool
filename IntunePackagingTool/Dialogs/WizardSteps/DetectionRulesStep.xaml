<UserControl x:Class="IntunePackagingTool.WizardSteps.DetectionRulesStep"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800">

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <StackPanel Margin="20">

            <!-- Header Section -->
            <TextBlock Text="Detection Rules" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>
            <TextBlock Text="Configure how Intune will detect if this application is already installed on target devices." 
                       TextWrapping="Wrap" Margin="0,0,0,20" Foreground="Gray"/>

            <!-- Rule Count Indicator -->
            <Border Name="RuleCountIndicator" 
                    BorderBrush="LightGray" BorderThickness="1" 
                    CornerRadius="5" Padding="10" Margin="0,0,0,15">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="📋" FontSize="16" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <TextBlock Name="RuleCountText" Text="No rules configured" 
                               VerticalAlignment="Center" FontWeight="SemiBold"/>
                </StackPanel>
            </Border>

            <!-- Add Detection Rule Buttons -->
            <TextBlock Text="Add Detection Rule:" FontWeight="SemiBold" Margin="0,0,0,10"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Margin="0,0,0,20">
                <Button Name="AddFileDetectionButton" Content="📁 Add File Detection" 
                        Click="AddFileDetectionButton_Click" Margin="5" Padding="15,8"
                        Background="#E3F2FD" BorderBrush="#1976D2"/>
                <Button Name="AddRegistryDetectionButton" Content="🗃️ Add Registry Detection" 
                        Click="AddRegistryDetectionButton_Click" Margin="5" Padding="15,8"
                        Background="#FFF3E0" BorderBrush="#F57C00"/>
                <Button Name="AddMsiDetectionButton" Content="📦 Add MSI Detection" 
                        Click="AddMsiDetectionButton_Click" Margin="5" Padding="15,8"
                        Background="#E8F5E8" BorderBrush="#4CAF50"/>
            </StackPanel>

            <!-- File Detection Editor -->
            <Border Name="FileDetectionEditor" Visibility="Collapsed" 
                    BorderBrush="#1976D2" BorderThickness="2" 
                    Background="#F8FBFF" Margin="0,0,0,15" Padding="20" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="📁 File Detection Rule" FontWeight="Bold" FontSize="15" 
                               Foreground="#1976D2" Margin="0,0,0,15"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="File Path:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Name="FilePathTextBox" 
                                 Margin="0,0,8,10" Padding="5"/>
                        <Button Grid.Row="0" Grid.Column="2" Name="BrowseFileButton" Content="Browse..." 
                                Click="BrowseFileButton_Click" Padding="12,5" Margin="0,0,0,10"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="File Name:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Name="FileNameTextBox" 
                                 Margin="0,0,0,10" Padding="5"/>

                        <CheckBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" Name="CheckVersionCheckBox" 
                                 Content="Check file version" Margin="0,5,0,0"/>
                    </Grid>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                        <Button Content="✅ Save" Click="SaveFileDetectionRule_Click" 
                                Margin="0,0,10,0" Padding="20,8" Background="#4CAF50" Foreground="White"/>
                        <Button Content="❌ Cancel" Click="CancelFileEditor_Click" 
                                Padding="20,8" Background="#F44336" Foreground="White"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Registry Detection Editor -->
            <Border Name="RegistryDetectionEditor" Visibility="Collapsed" 
                    BorderBrush="#F57C00" BorderThickness="2" 
                    Background="#FFFBF5" Margin="0,0,0,15" Padding="20" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="🗃️ Registry Detection Rule" FontWeight="Bold" FontSize="15" 
                               Foreground="#F57C00" Margin="0,0,0,15"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Registry Path:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Name="RegistryPathTextBox" 
                                 Margin="0,0,8,10" Padding="5"/>
                        <Button Grid.Row="0" Grid.Column="2" Name="BrowseRegistryButton" Content="Browse..." 
                                Click="BrowseRegistryButton_Click" Padding="12,5" Margin="0,0,0,10"/>

                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Value Name:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <TextBox Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Name="RegistryValueNameTextBox" 
                                 Margin="0,0,0,10" Padding="5"/>

                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Detection Type:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <ComboBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" Name="RegistryDetectionTypeComboBox" 
                                  Margin="0,0,0,10" Padding="5">
                            <ComboBoxItem Content="Exists"/>
                            <ComboBoxItem Content="Does not exist"/>
                            <ComboBoxItem Content="Equals"/>
                        </ComboBox>

                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Expected Value:" 
                                   VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <TextBox Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2" Name="RegistryValueTextBox" 
                                 Padding="5"/>
                    </Grid>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                        <Button Content="✅ Save" Click="SaveRegistryDetectionRule_Click" 
                                Margin="0,0,10,0" Padding="20,8" Background="#4CAF50" Foreground="White"/>
                        <Button Content="❌ Cancel" Click="CancelRegistryEditor_Click" 
                                Padding="20,8" Background="#F44336" Foreground="White"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- MSI Detection Editor -->
            <Border Name="MsiDetectionEditor" Visibility="Collapsed" 
                    BorderBrush="#4CAF50" BorderThickness="2" 
                    Background="#F1F8E9" Margin="0,0,0,15" Padding="20" CornerRadius="8">
                <StackPanel>
                    <TextBlock Text="📦 MSI Detection Rule" FontWeight="Bold" FontSize="15" 
                               Foreground="#4CAF50" Margin="0,0,0,15"/>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="120"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- MSI Product Code -->
                        <TextBlock Grid.Row="0" Grid.Column="0" Text="Product Code:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <TextBox Grid.Row="0" Grid.Column="1" Name="MsiProductCodeTextBox" 
                                 Margin="0,0,8,10" Padding="5"
                                 ToolTip="Enter MSI product GUID, e.g., {12345678-1234-1234-1234-123456789012}"/>
                        <Button Grid.Row="0" Grid.Column="2" Name="BrowseMsiProductsButton" Content="Browse..." 
                                Click="BrowseMsiProductsButton_Click" Padding="12,5" Margin="0,0,0,10"/>

                        <!-- Version Check -->
                        <TextBlock Grid.Row="1" Grid.Column="0" Text="Version Check:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <StackPanel Grid.Row="1" Grid.Column="1" Grid.ColumnSpan="2" Orientation="Horizontal" Margin="0,0,0,10">
                            <RadioButton Name="MsiVersionCheckYes" Content="Yes" Margin="0,0,30,0"/>
                            <RadioButton Name="MsiVersionCheckNo" Content="No" IsChecked="True"/>
                        </StackPanel>

                        <!-- Operator -->
                        <TextBlock Grid.Row="2" Grid.Column="0" Text="Operator:" 
                                   VerticalAlignment="Center" Margin="0,0,10,10"/>
                        <ComboBox Grid.Row="2" Grid.Column="1" Grid.ColumnSpan="2" Name="MsiOperatorComboBox" 
                                  Margin="0,0,0,10" Padding="5"/>

                        <!-- Version Value -->
                        <TextBlock Grid.Row="3" Grid.Column="0" Text="Value:" 
                                   VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <TextBox Grid.Row="3" Grid.Column="1" Grid.ColumnSpan="2" Name="MsiVersionValueTextBox" 
                                 Padding="5" ToolTip="Version number, e.g., 1.0.0"/>
                    </Grid>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,20,0,0">
                        <Button Content="✅ Save" Click="SaveMsiDetectionRule_Click" 
                                Margin="0,0,10,0" Padding="20,8" Background="#4CAF50" Foreground="White"/>
                        <Button Content="❌ Cancel" Click="CancelMsiEditor_Click" 
                                Padding="20,8" Background="#F44336" Foreground="White"/>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- No Rules Panel -->
            <Border Name="NoRulesPanel" 
                    BorderBrush="#FF6B6B" BorderThickness="1" 
                    Background="#FFF5F5" Padding="20" Margin="0,0,0,15" CornerRadius="8">
                <StackPanel HorizontalAlignment="Center">
                    <TextBlock Text="⚠️" FontSize="24" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                    <TextBlock Text="No Detection Rules Configured" 
                               FontWeight="Bold" FontSize="16" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                    <TextBlock Text="At least one detection rule is required to proceed." 
                               HorizontalAlignment="Center" Foreground="Gray"/>
                </StackPanel>
            </Border>

            <!-- Detection Rules List -->
            <TextBlock Text="Configured Detection Rules:" FontWeight="SemiBold" 
                       Margin="0,10,0,10" FontSize="14"/>

            <ListView Name="DetectionRulesList" 
                      BorderBrush="LightGray" BorderThickness="1"
                      Background="White" MinHeight="150" MaxHeight="300">
                <ListView.ItemTemplate>
                    <DataTemplate>
                        <Border BorderBrush="LightGray" BorderThickness="0,0,0,1" Padding="10,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <!-- Rule Type Icon -->
                                <TextBlock Grid.Column="0" VerticalAlignment="Center" Margin="0,0,15,0" FontSize="16">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Type}" Value="File">
                                                    <Setter Property="Text" Value="📁"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Type}" Value="Registry">
                                                    <Setter Property="Text" Value="🗃️"/>
                                                </DataTrigger>
                                                <DataTrigger Binding="{Binding Type}" Value="MSI">
                                                    <Setter Property="Text" Value="📦"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>

                                <!-- Rule Details -->
                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding Title}" FontWeight="SemiBold" TextWrapping="Wrap"/>
                                    <TextBlock Text="{Binding Description}" Foreground="Gray" 
                                               FontSize="12" TextWrapping="Wrap" Margin="0,2,0,0"/>
                                </StackPanel>

                                <!-- Remove Button -->
                                <Button Grid.Column="2" Content="🗑️" 
                                        Click="RemoveDetectionRule_Click" Tag="{Binding}"
                                        Background="Transparent" BorderThickness="0"
                                        Padding="8" Margin="10,0,0,0"
                                        ToolTip="Remove this detection rule">
                                    <Button.Style>
                                        <Style TargetType="Button">
                                            <Setter Property="Foreground" Value="Gray"/>
                                            <Style.Triggers>
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="Foreground" Value="Red"/>
                                                    <Setter Property="Background" Value="#FFEBEE"/>
                                                </Trigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Button.Style>
                                </Button>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
                <ListView.Style>
                    <Style TargetType="ListView">
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding Items.Count, RelativeSource={RelativeSource Self}}" Value="0">
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListView">
                                            <Border BorderBrush="{TemplateBinding BorderBrush}" 
                                                    BorderThickness="{TemplateBinding BorderThickness}"
                                                    Background="{TemplateBinding Background}">
                                                <TextBlock Text="No detection rules configured yet. Add some rules above to get started!" 
                                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                                           Foreground="Gray" FontStyle="Italic" Margin="20"/>
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListView.Style>
            </ListView>

            <!-- Help Text -->
            <Border BorderBrush="#E0E0E0" BorderThickness="1" 
                    Background="#FAFAFA" Padding="15" Margin="0,20,0,0" CornerRadius="5">
                <StackPanel>
                    <TextBlock Text="💡 Detection Rule Guidelines:" FontWeight="Bold" Margin="0,0,0,10"/>
                    <TextBlock TextWrapping="Wrap" LineHeight="20">
                        <Run Text="• "/>
                        <Run Text="File Detection:" FontWeight="SemiBold"/>
                        <Run Text=" Checks for specific files or executables. Use for apps that install to predictable locations."/>
                        <LineBreak/>
                        <Run Text="• "/>
                        <Run Text="Registry Detection:" FontWeight="SemiBold"/>
                        <Run Text=" Looks for registry keys or values. Common for Windows applications and system integrations."/>
                        <LineBreak/>
                        <Run Text="• "/>
                        <Run Text="MSI Detection:" FontWeight="SemiBold"/>
                        <Run Text=" Detects MSI-installed applications by product code. Most reliable for MSI packages."/>
                        <LineBreak/><LineBreak/>
                        <Run Text="💡 Tip: Use the Browse buttons to easily select files and registry keys from your system."/>
                    </TextBlock>
                </StackPanel>
            </Border>

        </StackPanel>
    </ScrollViewer>
</UserControl>